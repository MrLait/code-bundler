# Bundle generated at: 2026-02-11T18:18:45.8494438+03:00
# Root: d:\Work\GitHub\.NetProjects\TestTasks\Innowaise\Tasks\fridge-api\
# Files: 78

FILE: Fridge.sln

Microsoft Visual Studio Solution File, Format Version 12.00
# Visual Studio Version 17
VisualStudioVersion = 17.0.31903.59
MinimumVisualStudioVersion = 10.0.40219.1
Project("{2150E333-8FDC-42A3-9474-1A3956D46DE8}") = "src", "src", "{827E0CD3-B72D-47B6-A68D-7590B98EB39B}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "Fridge.Api", "src\Fridge.Api\Fridge.Api.csproj", "{A134DFBE-CE3E-4C8B-BC35-4AEA75104FAB}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "Fridge.Application", "src\Fridge.Application\Fridge.Application.csproj", "{7278D487-E8EF-4506-9A43-9951263CA781}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "Fridge.Domain", "src\Fridge.Domain\Fridge.Domain.csproj", "{E11951FF-0A34-42D3-AC4B-72ED8DD52CE2}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "Fridge.Infrastructure", "src\Fridge.Infrastructure\Fridge.Infrastructure.csproj", "{262EDB60-2E3F-491A-947D-313E8BBE1EB8}"
EndProject
Project("{2150E333-8FDC-42A3-9474-1A3956D46DE8}") = "tests", "tests", "{0AB3BF05-4346-4AA6-1389-037BE0695223}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "Fridge.Application.Tests", "tests\Fridge.Application.Tests\Fridge.Application.Tests.csproj", "{7453B2B0-0846-4994-8437-5832E379E807}"
EndProject
Global
	GlobalSection(SolutionConfigurationPlatforms) = preSolution
		Debug|Any CPU = Debug|Any CPU
		Debug|x64 = Debug|x64
		Debug|x86 = Debug|x86
		Release|Any CPU = Release|Any CPU
		Release|x64 = Release|x64
		Release|x86 = Release|x86
	EndGlobalSection
	GlobalSection(ProjectConfigurationPlatforms) = postSolution
		{A134DFBE-CE3E-4C8B-BC35-4AEA75104FAB}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{A134DFBE-CE3E-4C8B-BC35-4AEA75104FAB}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{A134DFBE-CE3E-4C8B-BC35-4AEA75104FAB}.Debug|x64.ActiveCfg = Debug|Any CPU
		{A134DFBE-CE3E-4C8B-BC35-4AEA75104FAB}.Debug|x64.Build.0 = Debug|Any CPU
		{A134DFBE-CE3E-4C8B-BC35-4AEA75104FAB}.Debug|x86.ActiveCfg = Debug|Any CPU
		{A134DFBE-CE3E-4C8B-BC35-4AEA75104FAB}.Debug|x86.Build.0 = Debug|Any CPU
		{A134DFBE-CE3E-4C8B-BC35-4AEA75104FAB}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{A134DFBE-CE3E-4C8B-BC35-4AEA75104FAB}.Release|Any CPU.Build.0 = Release|Any CPU
		{A134DFBE-CE3E-4C8B-BC35-4AEA75104FAB}.Release|x64.ActiveCfg = Release|Any CPU
		{A134DFBE-CE3E-4C8B-BC35-4AEA75104FAB}.Release|x64.Build.0 = Release|Any CPU
		{A134DFBE-CE3E-4C8B-BC35-4AEA75104FAB}.Release|x86.ActiveCfg = Release|Any CPU
		{A134DFBE-CE3E-4C8B-BC35-4AEA75104FAB}.Release|x86.Build.0 = Release|Any CPU
		{7278D487-E8EF-4506-9A43-9951263CA781}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{7278D487-E8EF-4506-9A43-9951263CA781}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{7278D487-E8EF-4506-9A43-9951263CA781}.Debug|x64.ActiveCfg = Debug|Any CPU
		{7278D487-E8EF-4506-9A43-9951263CA781}.Debug|x64.Build.0 = Debug|Any CPU
		{7278D487-E8EF-4506-9A43-9951263CA781}.Debug|x86.ActiveCfg = Debug|Any CPU
		{7278D487-E8EF-4506-9A43-9951263CA781}.Debug|x86.Build.0 = Debug|Any CPU
		{7278D487-E8EF-4506-9A43-9951263CA781}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{7278D487-E8EF-4506-9A43-9951263CA781}.Release|Any CPU.Build.0 = Release|Any CPU
		{7278D487-E8EF-4506-9A43-9951263CA781}.Release|x64.ActiveCfg = Release|Any CPU
		{7278D487-E8EF-4506-9A43-9951263CA781}.Release|x64.Build.0 = Release|Any CPU
		{7278D487-E8EF-4506-9A43-9951263CA781}.Release|x86.ActiveCfg = Release|Any CPU
		{7278D487-E8EF-4506-9A43-9951263CA781}.Release|x86.Build.0 = Release|Any CPU
		{E11951FF-0A34-42D3-AC4B-72ED8DD52CE2}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{E11951FF-0A34-42D3-AC4B-72ED8DD52CE2}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{E11951FF-0A34-42D3-AC4B-72ED8DD52CE2}.Debug|x64.ActiveCfg = Debug|Any CPU
		{E11951FF-0A34-42D3-AC4B-72ED8DD52CE2}.Debug|x64.Build.0 = Debug|Any CPU
		{E11951FF-0A34-42D3-AC4B-72ED8DD52CE2}.Debug|x86.ActiveCfg = Debug|Any CPU
		{E11951FF-0A34-42D3-AC4B-72ED8DD52CE2}.Debug|x86.Build.0 = Debug|Any CPU
		{E11951FF-0A34-42D3-AC4B-72ED8DD52CE2}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{E11951FF-0A34-42D3-AC4B-72ED8DD52CE2}.Release|Any CPU.Build.0 = Release|Any CPU
		{E11951FF-0A34-42D3-AC4B-72ED8DD52CE2}.Release|x64.ActiveCfg = Release|Any CPU
		{E11951FF-0A34-42D3-AC4B-72ED8DD52CE2}.Release|x64.Build.0 = Release|Any CPU
		{E11951FF-0A34-42D3-AC4B-72ED8DD52CE2}.Release|x86.ActiveCfg = Release|Any CPU
		{E11951FF-0A34-42D3-AC4B-72ED8DD52CE2}.Release|x86.Build.0 = Release|Any CPU
		{262EDB60-2E3F-491A-947D-313E8BBE1EB8}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{262EDB60-2E3F-491A-947D-313E8BBE1EB8}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{262EDB60-2E3F-491A-947D-313E8BBE1EB8}.Debug|x64.ActiveCfg = Debug|Any CPU
		{262EDB60-2E3F-491A-947D-313E8BBE1EB8}.Debug|x64.Build.0 = Debug|Any CPU
		{262EDB60-2E3F-491A-947D-313E8BBE1EB8}.Debug|x86.ActiveCfg = Debug|Any CPU
		{262EDB60-2E3F-491A-947D-313E8BBE1EB8}.Debug|x86.Build.0 = Debug|Any CPU
		{262EDB60-2E3F-491A-947D-313E8BBE1EB8}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{262EDB60-2E3F-491A-947D-313E8BBE1EB8}.Release|Any CPU.Build.0 = Release|Any CPU
		{262EDB60-2E3F-491A-947D-313E8BBE1EB8}.Release|x64.ActiveCfg = Release|Any CPU
		{262EDB60-2E3F-491A-947D-313E8BBE1EB8}.Release|x64.Build.0 = Release|Any CPU
		{262EDB60-2E3F-491A-947D-313E8BBE1EB8}.Release|x86.ActiveCfg = Release|Any CPU
		{262EDB60-2E3F-491A-947D-313E8BBE1EB8}.Release|x86.Build.0 = Release|Any CPU
		{7453B2B0-0846-4994-8437-5832E379E807}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{7453B2B0-0846-4994-8437-5832E379E807}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{7453B2B0-0846-4994-8437-5832E379E807}.Debug|x64.ActiveCfg = Debug|Any CPU
		{7453B2B0-0846-4994-8437-5832E379E807}.Debug|x64.Build.0 = Debug|Any CPU
		{7453B2B0-0846-4994-8437-5832E379E807}.Debug|x86.ActiveCfg = Debug|Any CPU
		{7453B2B0-0846-4994-8437-5832E379E807}.Debug|x86.Build.0 = Debug|Any CPU
		{7453B2B0-0846-4994-8437-5832E379E807}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{7453B2B0-0846-4994-8437-5832E379E807}.Release|Any CPU.Build.0 = Release|Any CPU
		{7453B2B0-0846-4994-8437-5832E379E807}.Release|x64.ActiveCfg = Release|Any CPU
		{7453B2B0-0846-4994-8437-5832E379E807}.Release|x64.Build.0 = Release|Any CPU
		{7453B2B0-0846-4994-8437-5832E379E807}.Release|x86.ActiveCfg = Release|Any CPU
		{7453B2B0-0846-4994-8437-5832E379E807}.Release|x86.Build.0 = Release|Any CPU
	EndGlobalSection
	GlobalSection(SolutionProperties) = preSolution
		HideSolutionNode = FALSE
	EndGlobalSection
	GlobalSection(NestedProjects) = preSolution
		{A134DFBE-CE3E-4C8B-BC35-4AEA75104FAB} = {827E0CD3-B72D-47B6-A68D-7590B98EB39B}
		{7278D487-E8EF-4506-9A43-9951263CA781} = {827E0CD3-B72D-47B6-A68D-7590B98EB39B}
		{E11951FF-0A34-42D3-AC4B-72ED8DD52CE2} = {827E0CD3-B72D-47B6-A68D-7590B98EB39B}
		{262EDB60-2E3F-491A-947D-313E8BBE1EB8} = {827E0CD3-B72D-47B6-A68D-7590B98EB39B}
		{7453B2B0-0846-4994-8437-5832E379E807} = {0AB3BF05-4346-4AA6-1389-037BE0695223}
	EndGlobalSection
EndGlobal

FILE: src\Fridge.Api\Controllers\FridgeModelsController.cs
using Fridge.Application.Features.FridgeModels.Queries.GetFridgeModels;
using MediatR;
using Microsoft.AspNetCore.Mvc;

namespace Fridge.Api.Controllers;

[ApiController]
[Route("api/fridge-models")]
public sealed class FridgeModelsController(IMediator mediator) : ControllerBase
{
    [HttpGet]
    public async Task<IActionResult> GetFridgeModels(CancellationToken ct)
        => Ok(await mediator.Send(new GetFridgeModelsQuery(), ct));
}

FILE: src\Fridge.Api\Controllers\FridgeProductsController.cs
using Fridge.Application.Features.FridgeProducts.Commands.DeleteFridgeProduct;
using MediatR;
using Microsoft.AspNetCore.Mvc;

namespace Fridge.Api.Controllers;

[ApiController]
[Route("api/fridge-products")]
public sealed class FridgeProductsController(IMediator mediator) : ControllerBase
{
    [HttpDelete("{id:guid}")]
    public async Task<IActionResult> Delete([FromRoute] Guid id, CancellationToken cancellationToken)
    {
        await mediator.Send(new DeleteFridgeProductCommand(id), cancellationToken);
        return NoContent();
    }
}

FILE: src\Fridge.Api\Controllers\FridgesController.cs
using Fridge.Application.Features.Fridges.Commands.AddProductToFridge;
using Fridge.Application.Features.Fridges.Commands.CreateFridge;
using Fridge.Application.Features.Fridges.Commands.DeleteFridge;
using Fridge.Application.Features.Fridges.Commands.UpdateFridge;
using Fridge.Application.Features.Fridges.Queries.GetFridgeById;
using Fridge.Application.Features.Fridges.Queries.GetFridgeProducts;
using Fridge.Application.Features.Fridges.Queries.GetFridges;
using MediatR;
using Microsoft.AspNetCore.Mvc;

namespace Fridge.Api.Controllers;

[ApiController]
[Route("api/fridges")]
public class FridgesController(IMediator mediator) : ControllerBase
{
    [HttpGet]
    public async Task<IActionResult> GetFridges(CancellationToken cancellationToken)
        => Ok(await mediator.Send(new GetFridgesQuery(), cancellationToken));

    [HttpGet("{id:guid}")]
    public async Task<IActionResult> GetFridgeById([FromRoute] Guid id, CancellationToken ct)
        => Ok(await mediator.Send(new GetFridgeByIdQuery(id), ct));

    [HttpGet("{fridgeId:guid}/products")]
    public async Task<IActionResult> GetFridgeProducts([FromRoute] Guid fridgeId, CancellationToken cancellationToken)
        => Ok(await mediator.Send(new GetFridgeProductsQuery(fridgeId), cancellationToken));

    [HttpPost("{fridgeId:guid}/products")]
    public async Task<IActionResult> AddProductToFridge([FromRoute] Guid fridgeId, [FromBody] AddProductToFridgeRequest body, CancellationToken cancellationToken)
    {
        var id = await mediator.Send(new AddProductToFridgeCommand(fridgeId, body.ProductId, body.Quantity), cancellationToken);
        return Ok(new { fridgeProductId = id });
    }

    [HttpPost]
    public async Task<IActionResult> CreateFridge([FromBody] CreateFridgeRequest body, CancellationToken ct)
    {
        var initialProducts = body.InitialProducts?
            .Select(x => new InitialFridgeProductItem(x.ProductId, x.Quantity))
            .ToList();

        var id = await mediator.Send(new CreateFridgeCommand(body.Name, body.OwnerName, body.ModelId, initialProducts), ct);
        return CreatedAtAction(nameof(GetFridgeById), new { id }, new { id });
    }

    [HttpPut("{id:guid}")]
    public async Task<IActionResult> UpdateFridge([FromRoute] Guid id, UpdateFridgeRequest body, CancellationToken ct)
    {
        await mediator.Send(new UpdateFridgeCommand(id, body.Name, body.OwnerName, body.ModelId), ct);
        return NoContent();
    }

    [HttpDelete("{id:guid}")]
    public async Task<IActionResult> DeleteFridge([FromRoute] Guid id, CancellationToken ct)
    {
        await mediator.Send(new DeleteFridgeCommand(id), ct);
        return NoContent();
    }
}

FILE: src\Fridge.Api\Controllers\MaintenanceController.cs
using Fridge.Application.Features.Maintenance.Commands.RestockZeroQuantity;
using MediatR;
using Microsoft.AspNetCore.Mvc;

namespace Fridge.Api.Controllers;

[ApiController]
[Route("api/maintenance")]
public sealed class MaintenanceController(IMediator mediator) : ControllerBase
{
    [HttpPost("restock-zero")]
    public async Task<IActionResult> RestockZero(CancellationToken ct)
    {
        var update = await mediator.Send(new RestockZeroQuantityCommand(), ct);
        return Ok(new { update });
    }
}

FILE: src\Fridge.Api\Controllers\ProductsController.cs
using Fridge.Application.Features.Products.Commands.UpdateProduct;
using Fridge.Application.Features.Products.Queries.GetProductById;
using Fridge.Application.Features.Products.Queries.GetProducts;
using MediatR;
using Microsoft.AspNetCore.Mvc;

namespace Fridge.Api.Controllers
{
    [ApiController]
    [Route("api/products")]
    public sealed class ProductsController(IMediator mediator) : ControllerBase
    {

        [HttpGet]
        public async Task<IActionResult> GetAll(CancellationToken ct)
        {
            var products = await mediator.Send(new GetProductsQuery(), ct);
            return Ok(products);
        }

        [HttpGet("{id:guid}")]
        public async Task<IActionResult> GetProduct([FromRoute] Guid id, CancellationToken ct)
            => Ok(await mediator.Send(new GetProductByIdQuery(id), ct));

        [HttpPut("{id:guid}")]
        public async Task<IActionResult> Update([FromRoute] Guid id, UpdateProductRequest body)
        {
            var dto = await mediator.Send(new UpdateProductCommand(id, body.Name, body.DefaultQuantity));
            return Ok(dto);
        }
    }
}

FILE: src\Fridge.Api\ExceptionHandling\ExceptionHandlingExtensions.cs
using Fridge.Api.ExceptionHandling.Mappers;

namespace Fridge.Api.ExceptionHandling;

public static class ExceptionHandlingExtensions
{

    public static IServiceCollection AddApiExceptionHandling(this IServiceCollection services)
    {
        services.AddProblemDetails();
        services.AddExceptionHandler<GlobalExceptionHandler>();

        services.AddSingleton<IExceptionMapper, ValidationExceptionMapper>();
        services.AddSingleton<IExceptionMapper, NotFoundExceptionMapper>();
        services.AddSingleton<IExceptionMapper, UniqueConstraintExceptionMapper>();
        services.AddSingleton<IExceptionMapper, BusinessRuleViolationExceptionMapper>();
        services.AddSingleton<IExceptionMapper, FallbackExceptionMapper>();

        return services;
    }

}

FILE: src\Fridge.Api\ExceptionHandling\GlobalExceptionHandler.cs
using Microsoft.AspNetCore.Diagnostics;

namespace Fridge.Api.ExceptionHandling;
public sealed class GlobalExceptionHandler(IEnumerable<IExceptionMapper> mappers) : IExceptionHandler
{
    public async ValueTask<bool> TryHandleAsync(
        HttpContext httpContext,
        Exception exception,
        CancellationToken cancellationToken)
    {
        var mapper = mappers.FirstOrDefault(m => m.CanHandle(exception));
        if (mapper is null)
            return false;

        var problem = mapper.Map(exception);

        httpContext.Response.StatusCode = problem.Status ?? StatusCodes.Status500InternalServerError;
        await httpContext.Response.WriteAsJsonAsync(problem, cancellationToken);
        return true;
    }
}

FILE: src\Fridge.Api\ExceptionHandling\IExceptionMapper.cs
using Microsoft.AspNetCore.Mvc;

namespace Fridge.Api.ExceptionHandling;

public interface IExceptionMapper
{
    bool CanHandle(Exception exception);
    ProblemDetails Map(Exception ex);
}

FILE: src\Fridge.Api\ExceptionHandling\Mappers\BusinessRuleViolationExceptionMapper.cs
using Fridge.Application.Common.Exceptions;
using Microsoft.AspNetCore.Mvc;

namespace Fridge.Api.ExceptionHandling.Mappers;

public sealed class BusinessRuleViolationExceptionMapper : IExceptionMapper
{
    public bool CanHandle(Exception exception) => exception is BusinessRuleViolationException;

    public ProblemDetails Map(Exception ex) => new()
    {
        Status = StatusCodes.Status422UnprocessableEntity,
        Title = "Business rule violation",
        Detail = ex.Message
    };
}

FILE: src\Fridge.Api\ExceptionHandling\Mappers\FallbackExceptionMapper.cs
using Microsoft.AspNetCore.Mvc;

namespace Fridge.Api.ExceptionHandling.Mappers;

public sealed class FallbackExceptionMapper : IExceptionMapper
{
    public bool CanHandle(Exception ex) => true;

    public ProblemDetails Map(Exception ex) => new()
    {
        Status = StatusCodes.Status500InternalServerError,
        Title = "Server error",
        Detail = "An expected error occurred."
    };
}

FILE: src\Fridge.Api\ExceptionHandling\Mappers\NotFoundExceptionMapper.cs
using Microsoft.AspNetCore.Mvc;

namespace Fridge.Api.ExceptionHandling.Mappers;

public sealed class NotFoundExceptionMapper : IExceptionMapper
{
    public bool CanHandle(Exception ex) => ex is KeyNotFoundException;

    public ProblemDetails Map(Exception ex) => new()
    {
        Status = StatusCodes.Status404NotFound,
        Title = "Not found",
        Detail = ex.Message
    };
}

FILE: src\Fridge.Api\ExceptionHandling\Mappers\UniqueConstraintExceptionMapper.cs
using Microsoft.AspNetCore.Mvc;
using Microsoft.Data.SqlClient;
using Microsoft.EntityFrameworkCore;

namespace Fridge.Api.ExceptionHandling.Mappers;

public sealed class UniqueConstraintExceptionMapper : IExceptionMapper
{
    public bool CanHandle(Exception ex) =>
        ex is DbUpdateException dbu && dbu.InnerException is SqlException sqlEx
        && (sqlEx.Number == 2601 || sqlEx.Number == 2627);

    public ProblemDetails Map(Exception ex) => new()
    {
        Status = StatusCodes.Status409Conflict,
        Title = "Conflict 409",
        Detail = "Unique constraint violation."
    };
}

FILE: src\Fridge.Api\ExceptionHandling\Mappers\ValidationExceptionMapper.cs
using FluentValidation;
using Microsoft.AspNetCore.Mvc;

namespace Fridge.Api.ExceptionHandling.Mappers;

public sealed class ValidationExceptionMapper : IExceptionMapper
{
    public bool CanHandle(Exception ex) => ex is ValidationException;

    public ProblemDetails Map(Exception ex)
    {
        var ve = (ValidationException)ex;

        var errors = ve.Errors
            .GroupBy(e => e.PropertyName)
            .ToDictionary(g => g.Key, g => g.Select(x => x.ErrorMessage).ToArray());

        return new ValidationProblemDetails(errors)
        {
            Status = StatusCodes.Status400BadRequest,
            Title = "Validation error"
        };
    }
}

FILE: src\Fridge.Api\Program.cs
using Fridge.Infrastructure;
using Fridge.Application;
using Fridge.Api.ExceptionHandling;
using Fridge.Infrastructure.Persistence;

var builder = WebApplication.CreateBuilder(args);

builder.Services.AddControllers();
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();


builder.Services.AddApplication();
builder.Services.AddInfrastructure(builder.Configuration);

builder.Services.AddApiExceptionHandling();


var app = builder.Build();

app.UseExceptionHandler();

if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();

    using var scope = app.Services.CreateScope();
    var dbSeeder = scope.ServiceProvider.GetRequiredService<DbSeeder>();
    await dbSeeder.SeedAsync();
}

app.UseHttpsRedirection();
app.MapControllers();

app.Run();

FILE: src\Fridge.Application\Common\Behaviors\ValidationBehavior.cs
using FluentValidation;
using MediatR;

namespace Fridge.Application.Common.Behaviors;
public sealed class ValidationBehavior<TRequest, TResponse>(IEnumerable<IValidator<TRequest>> validators) : IPipelineBehavior<TRequest, TResponse>
    where TRequest : IRequest<TResponse>
{
    private readonly IEnumerable<IValidator<TRequest>> _validators = validators;

    public async Task<TResponse> Handle(TRequest request, RequestHandlerDelegate<TResponse> next, CancellationToken cancellationToken)
    {
        if (_validators.Any())
        {
            var context = new ValidationContext<TRequest>(request);

            var failures = (await Task.WhenAll(
                _validators.Select(v => v.ValidateAsync(context, cancellationToken))))
                .SelectMany(r => r.Errors)
                .ToList();

            if (failures.Count != 0)
                throw new ValidationException(failures);
        }

        return await next(cancellationToken);
    }
}

FILE: src\Fridge.Application\Common\Exceptions\BusinessRuleViolationException .cs
namespace Fridge.Application.Common.Exceptions;

public sealed class BusinessRuleViolationException(string message) : Exception(message)
{
}

FILE: src\Fridge.Application\Common\Interfaces\IAppDbContext.cs

using Fridge.Domain.Entities;
using Microsoft.EntityFrameworkCore;

namespace Fridge.Application.Common.Interfaces;

public interface IAppDbContext
{
    DbSet<Domain.Entities.Fridge> Fridges { get; }
    DbSet<FridgeModel> FridgeModels { get; }
    DbSet<FridgeProduct> FridgeProducts { get; }
    DbSet<Product> Products { get; }
    Task<int> SaveChangesAsync(CancellationToken cancellationToken = default);
}

FILE: src\Fridge.Application\Common\Interfaces\IFridgeProductService.cs
namespace Fridge.Application.Common.Interfaces;

public interface IFridgeProductService
{
    Task<Guid> AddProductAsync(
        Guid fridgeId,
        Guid productId,
        int quantity,
        bool saveChanges = true,
        CancellationToken ct = default);
}

FILE: src\Fridge.Application\Common\Interfaces\IRestockService.cs
namespace Fridge.Application.Common.Interfaces;

public interface IRestockService
{
    Task<int> RestockZeroQuantityAsync(CancellationToken ct = default);
}

FILE: src\Fridge.Application\DependencyInjection.cs
using MediatR;
using FluentValidation;
using Microsoft.Extensions.DependencyInjection;
using System.Reflection;
using Fridge.Application.Common.Behaviors;

namespace Fridge.Application
{
    public static class DependencyInjection
    {
        public static IServiceCollection AddApplication(this IServiceCollection services)
        {
            var assembly = typeof(DependencyInjection).Assembly;

            services.AddMediatR(cfg => cfg.RegisterServicesFromAssembly(assembly));
            services.AddValidatorsFromAssembly(assembly);

            services.AddTransient(typeof(IPipelineBehavior<,>), typeof(ValidationBehavior<,>));

            return services;
        }
    }
}

FILE: src\Fridge.Application\Features\FridgeModels\Dtos\FridgeModelDto.cs
namespace Fridge.Application.Features.FridgeModels.Dtos;

public sealed record FridgeModelDto
(
        Guid Id,
        string Name,
        int? Year
);

FILE: src\Fridge.Application\Features\FridgeModels\Queries\GetFridgeModels\GetFridgeModelsQuery.cs
using Fridge.Application.Features.FridgeModels.Dtos;
using MediatR;

namespace Fridge.Application.Features.FridgeModels.Queries.GetFridgeModels;

public sealed record GetFridgeModelsQuery
    : IRequest<IReadOnlyList<FridgeModelDto>>;

FILE: src\Fridge.Application\Features\FridgeModels\Queries\GetFridgeModels\GetFridgeModelsQueryHandler.cs
using Fridge.Application.Common.Interfaces;
using Fridge.Application.Features.FridgeModels.Dtos;
using MediatR;
using Microsoft.EntityFrameworkCore;

namespace Fridge.Application.Features.FridgeModels.Queries.GetFridgeModels;

public sealed class GetFridgeModelsQueryHandler(IAppDbContext db)
    : IRequestHandler<GetFridgeModelsQuery, IReadOnlyList<FridgeModelDto>>
{
    public async Task<IReadOnlyList<FridgeModelDto>> Handle(GetFridgeModelsQuery request, CancellationToken ct)
    {
        var entities = await db.FridgeModels
            .AsNoTracking()
            .OrderBy(x => x.Name)
            .Select(x => new FridgeModelDto(x.Id, x.Name, x.Year))
            .ToListAsync(ct);

        return entities;
    }
}

FILE: src\Fridge.Application\Features\FridgeProducts\Commands\DeleteFridgeProduct\DeleteFridgeProductCommand.cs
using MediatR;

namespace Fridge.Application.Features.FridgeProducts.Commands.DeleteFridgeProduct;

public sealed record DeleteFridgeProductCommand(Guid Id) : IRequest;

FILE: src\Fridge.Application\Features\FridgeProducts\Commands\DeleteFridgeProduct\DeleteFridgeProductCommandHandler.cs
using Fridge.Application.Common.Interfaces;
using MediatR;
using Microsoft.EntityFrameworkCore;

namespace Fridge.Application.Features.FridgeProducts.Commands.DeleteFridgeProduct;

public sealed class DeleteFridgeProductCommandHandler(IAppDbContext db)
    : IRequestHandler<DeleteFridgeProductCommand>
{
    public async Task Handle(DeleteFridgeProductCommand request, CancellationToken cancellationToken)
    {
        var entity = await db.FridgeProducts
            .SingleOrDefaultAsync(x => x.Id == request.Id, cancellationToken);

        if (entity is null)
            throw new KeyNotFoundException($"FridgeProduct '{request.Id}' not found.");

        db.FridgeProducts.Remove(entity);
        await db.SaveChangesAsync(cancellationToken);
    }
}

FILE: src\Fridge.Application\Features\FridgeProducts\Commands\DeleteFridgeProduct\DeleteFridgeProductCommandValidator .cs
using FluentValidation;

namespace Fridge.Application.Features.FridgeProducts.Commands.DeleteFridgeProduct;

public class DeleteFridgeProductCommandValidator : AbstractValidator<DeleteFridgeProductCommand>
{
    public DeleteFridgeProductCommandValidator()
    {
        RuleFor(x => x.Id).NotEmpty();
    }
}

FILE: src\Fridge.Application\Features\Fridges\Commands\AddProductToFridge\AddProductToFridgeCommand.cs
using MediatR;

namespace Fridge.Application.Features.Fridges.Commands.AddProductToFridge;

public sealed record AddProductToFridgeCommand(Guid FridgeId, Guid ProductId, int Quantity) : IRequest<Guid>;

FILE: src\Fridge.Application\Features\Fridges\Commands\AddProductToFridge\AddProductToFridgeCommandHandler.cs
using Fridge.Application.Common.Interfaces;
using MediatR;

namespace Fridge.Application.Features.Fridges.Commands.AddProductToFridge;

public sealed class AddProductToFridgeCommandHandler(IFridgeProductService service)
    : IRequestHandler<AddProductToFridgeCommand, Guid>
{
    public async Task<Guid> Handle(AddProductToFridgeCommand request, CancellationToken ct)
        => await service.AddProductAsync(request.FridgeId, request.ProductId, request.Quantity, true, ct);
}

FILE: src\Fridge.Application\Features\Fridges\Commands\AddProductToFridge\AddProductToFridgeCommandValidator.cs
using FluentValidation;

namespace Fridge.Application.Features.Fridges.Commands.AddProductToFridge;

public class AddProductToFridgeCommandValidator : AbstractValidator<AddProductToFridgeCommand>
{
    public AddProductToFridgeCommandValidator()
    {
        RuleFor(x => x.FridgeId).NotEmpty();
        RuleFor(x => x.ProductId).NotEmpty();
        RuleFor(x => x.Quantity).NotEmpty();
    }
}

FILE: src\Fridge.Application\Features\Fridges\Commands\AddProductToFridge\AddProductToFridgeRequest.cs
namespace Fridge.Application.Features.Fridges.Commands.AddProductToFridge;

public sealed record AddProductToFridgeRequest(Guid ProductId, int Quantity);

FILE: src\Fridge.Application\Features\Fridges\Commands\CreateFridge\CreateFridgeCommand.cs
using MediatR;

namespace Fridge.Application.Features.Fridges.Commands.CreateFridge;

public sealed record CreateFridgeCommand(
    string Name,
    string? OwnerName,
    Guid ModelId,
    List<InitialFridgeProductItem>? InitialProducts
    ) : IRequest<Guid>;

FILE: src\Fridge.Application\Features\Fridges\Commands\CreateFridge\CreateFridgeCommandHandler.cs
using Fridge.Application.Common.Interfaces;
using Fridge.Domain.Entities;
using MediatR;
using Microsoft.EntityFrameworkCore;

namespace Fridge.Application.Features.Fridges.Commands.CreateFridge;

public sealed class CreateFridgeCommandHandler(IAppDbContext db)
    : IRequestHandler<CreateFridgeCommand, Guid>
{
    public async Task<Guid> Handle(CreateFridgeCommand request, CancellationToken ct)
    {
        var fridgeModelExists = await db
            .FridgeModels
            .AnyAsync(x => x.Id == request.ModelId, ct);

        if (!fridgeModelExists)
            throw new KeyNotFoundException($"FridgeModel '{request.ModelId}' not found.");

        var items = request.InitialProducts ?? [];

        var productIds = items.Select(x => x.ProductId).Distinct().ToList();

        if (productIds.Count > 0)
        {
            var existingProductIds = await db.Products
                .Where(x => productIds.Contains(x.Id))
                .Select(x => x.Id)
                .ToListAsync(ct);

            var missingIds = productIds.Except(existingProductIds).ToList();

            if (missingIds.Count > 0)
                throw new KeyNotFoundException($"Some products not found: {string.Join(", ", missingIds)}");
        }
        var fridgeId = Guid.NewGuid();
        var fridge = new Domain.Entities.Fridge
        {
            Id = fridgeId,
            Name = request.Name,
            OwnerName = request.OwnerName,
            ModelId = request.ModelId
        };

        foreach (var item in items)
        {
            fridge.FridgeProducts.Add(new FridgeProduct()
            {
                Id = Guid.NewGuid(),
                ProductId = item.ProductId,
                Quantity = item.Quantity
            });
        }

        db.Fridges.Add(fridge);
        await db.SaveChangesAsync(ct);

        return fridge.Id;
    }
}

FILE: src\Fridge.Application\Features\Fridges\Commands\CreateFridge\CreateFridgeCommandValidator.cs
using FluentValidation;

namespace Fridge.Application.Features.Fridges.Commands.CreateFridge;

public sealed class CreateFridgeCommandValidator
    : AbstractValidator<CreateFridgeCommand>
{
    public CreateFridgeCommandValidator()
    {
        RuleFor(x => x.Name).NotEmpty().MaximumLength(200);
        RuleFor(x => x.OwnerName).MaximumLength(200);
        RuleFor(x => x.ModelId).NotEmpty();

        When(x => x.InitialProducts is not null && x.InitialProducts.Count > 0, () =>
        {
            RuleForEach(x => x.InitialProducts!).ChildRules(item =>
            {
                item.RuleFor(i => i.ProductId).NotEmpty();
                item.RuleFor(i => i.Quantity).GreaterThan(0);
            });

            RuleFor(x => x.InitialProducts!)
                .Must(list => list.Select(i => i.ProductId).Distinct().Count() == list.Count)
                .WithMessage("InitialProducts contains duplicates ProductId.");
        });
    }
}

FILE: src\Fridge.Application\Features\Fridges\Commands\CreateFridge\CreateFridgeRequest.cs
namespace Fridge.Application.Features.Fridges.Commands.CreateFridge;

public sealed record InitialProductRequest(Guid ProductId, int Quantity);

public sealed record CreateFridgeRequest
(
    string Name,
    string? OwnerName,
    Guid ModelId,
    List<InitialProductRequest>? InitialProducts
);

FILE: src\Fridge.Application\Features\Fridges\Commands\CreateFridge\InitialFridgeProductItem.cs
namespace Fridge.Application.Features.Fridges.Commands.CreateFridge;

public sealed record InitialFridgeProductItem(Guid ProductId, int Quantity);

FILE: src\Fridge.Application\Features\Fridges\Commands\DeleteFridge\DeleteFridgeCommand.cs

using MediatR;

namespace Fridge.Application.Features.Fridges.Commands.DeleteFridge;

public sealed record DeleteFridgeCommand(Guid Id)
    : IRequest;

FILE: src\Fridge.Application\Features\Fridges\Commands\DeleteFridge\DeleteFridgeCommandHandler.cs
using Fridge.Application.Common.Interfaces;
using MediatR;
using Microsoft.EntityFrameworkCore;

namespace Fridge.Application.Features.Fridges.Commands.DeleteFridge;

public sealed class DeleteFridgeCommandHandler(IAppDbContext db)
    : IRequestHandler<DeleteFridgeCommand>
{
    public async Task Handle(DeleteFridgeCommand request, CancellationToken ct)
    {
        var fridge = await db.Fridges
            .SingleOrDefaultAsync(x => x.Id == request.Id, ct);

        if (fridge is null)
            throw new KeyNotFoundException($"Fridge '{request.Id}' not found.");

        db.Fridges.Remove(fridge);
        await db.SaveChangesAsync(ct);
        //ToDo на связи FridgeProduct -> Fridge стоит cascade delete
    }
}

FILE: src\Fridge.Application\Features\Fridges\Commands\DeleteFridge\DeleteFridgeCommandValidator.cs
using FluentValidation;

namespace Fridge.Application.Features.Fridges.Commands.DeleteFridge;

public sealed class DeleteFridgeCommandValidator
    : AbstractValidator<DeleteFridgeCommand>
{
    public DeleteFridgeCommandValidator()
    {
        RuleFor(x => x.Id).NotEmpty();
    }
}

FILE: src\Fridge.Application\Features\Fridges\Commands\UpdateFridge\UpdateFridgeCommand.cs

using MediatR;

namespace Fridge.Application.Features.Fridges.Commands.UpdateFridge;

public sealed record UpdateFridgeCommand(Guid Id, string Name, string? OwnerName, Guid ModelId)
    : IRequest;

FILE: src\Fridge.Application\Features\Fridges\Commands\UpdateFridge\UpdateFridgeCommandHandler.cs
using Fridge.Application.Common.Interfaces;
using MediatR;
using Microsoft.EntityFrameworkCore;

namespace Fridge.Application.Features.Fridges.Commands.UpdateFridge;

public sealed class UpdateFridgeCommandHandler(IAppDbContext db)
    : IRequestHandler<UpdateFridgeCommand>
{
    public async Task Handle(UpdateFridgeCommand request, CancellationToken ct)
    {
        var fridge = await db.Fridges
            .SingleOrDefaultAsync(x => x.Id == request.Id, ct);

        if (fridge is null)
            throw new KeyNotFoundException($"Fridge '{request.Id}' not found.");

        if (fridge.ModelId != request.ModelId)
        {
            var fridgeModelExists = await db.FridgeModels
                    .AnyAsync(x => x.Id == request.ModelId, ct);

            if (!fridgeModelExists)
                throw new KeyNotFoundException($"FridgeModel '{request.ModelId}' not found.");
        }

        (fridge.Name, fridge.OwnerName, fridge.ModelId) = (request.Name, request.OwnerName, request.ModelId);

        await db.SaveChangesAsync(ct);
    }
}

FILE: src\Fridge.Application\Features\Fridges\Commands\UpdateFridge\UpdateFridgeCommandValidator.cs
using FluentValidation;

namespace Fridge.Application.Features.Fridges.Commands.UpdateFridge;

public sealed class UpdateFridgeCommandValidator
    : AbstractValidator<UpdateFridgeCommand>
{
    public UpdateFridgeCommandValidator()
    {
        RuleFor(x => x.Id).NotEmpty();
        RuleFor(x => x.Name).NotEmpty().MaximumLength(200);
        RuleFor(x => x.OwnerName).MaximumLength(200);
        RuleFor(x => x.ModelId).NotEmpty();
    }
}

FILE: src\Fridge.Application\Features\Fridges\Commands\UpdateFridge\UpdateFridgeRequest.cs
namespace Fridge.Application.Features.Fridges.Commands.UpdateFridge;

public sealed record UpdateFridgeRequest
(
    string Name,
    string? OwnerName,
    Guid ModelId
);

FILE: src\Fridge.Application\Features\Fridges\Dtos\FridgeDto.cs
namespace Fridge.Application.Features.Fridges.Dtos;
public sealed record FridgeDto
(
    Guid Id,
    string Name,
    string? OwnerName,
    Guid ModelId,
    string ModelName,
    int? ModelYear
);

FILE: src\Fridge.Application\Features\Fridges\Dtos\FridgeProductDto.cs
namespace Fridge.Application.Features.Fridges.Dtos;
public sealed record FridgeProductDto
(
    Guid Id,
    Guid ProductId,
    string ProductName,
    int Quantity,
    int? ProductDefaultQuantity
);

FILE: src\Fridge.Application\Features\Fridges\Queries\GetFridgeById\GetFridgeByIdQuery.cs

using Fridge.Application.Features.Fridges.Dtos;
using MediatR;

namespace Fridge.Application.Features.Fridges.Queries.GetFridgeById;

public sealed record GetFridgeByIdQuery(Guid Id) : IRequest<FridgeDto>;

FILE: src\Fridge.Application\Features\Fridges\Queries\GetFridgeById\GetFridgeByIdQueryHandler.cs
using Fridge.Application.Common.Interfaces;
using Fridge.Application.Features.Fridges.Dtos;
using MediatR;
using Microsoft.EntityFrameworkCore;

namespace Fridge.Application.Features.Fridges.Queries.GetFridgeById;

public sealed class GetFridgeByIdQueryHandler(IAppDbContext db)
    : IRequestHandler<GetFridgeByIdQuery, FridgeDto>
{
    public async Task<FridgeDto> Handle(GetFridgeByIdQuery request, CancellationToken ct)
    {
        var dto = await db.Fridges
            .AsNoTracking()
            .Include(x => x.Model)
            .Where(x => x.Id == request.Id)
            .Select(x => new FridgeDto(x.Id, x.Name, x.OwnerName, x.ModelId, x.Model.Name, x.Model.Year))
            .SingleOrDefaultAsync(ct);

        if (dto is null)
            throw new KeyNotFoundException($"Fridge '{request.Id}' not found.");

        return dto;
    }
}

FILE: src\Fridge.Application\Features\Fridges\Queries\GetFridgeProducts\GetFridgeProductsQuery.cs
using Fridge.Application.Features.Fridges.Dtos;
using MediatR;

namespace Fridge.Application.Features.Fridges.Queries.GetFridgeProducts;
public sealed record GetFridgeProductsQuery(Guid FridgeId) : IRequest<IReadOnlyList<FridgeProductDto>>;

FILE: src\Fridge.Application\Features\Fridges\Queries\GetFridgeProducts\GetFridgeProductsQueryHandler.cs

using Fridge.Application.Common.Interfaces;
using Fridge.Application.Features.Fridges.Dtos;
using MediatR;
using Microsoft.EntityFrameworkCore;

namespace Fridge.Application.Features.Fridges.Queries.GetFridgeProducts;

public sealed class GetFridgeProductsQueryHandler(IAppDbContext db)
    : IRequestHandler<GetFridgeProductsQuery, IReadOnlyList<FridgeProductDto>>
{
    public async Task<IReadOnlyList<FridgeProductDto>> Handle(GetFridgeProductsQuery request, CancellationToken cancellationToken)
        => await db.FridgeProducts
            .AsNoTracking()
            .Where(x => x.FridgeId == request.FridgeId)
            .Include(x => x.Product)
            .Select(x => new FridgeProductDto(
                x.Id,
                x.ProductId,
                x.Product.Name,
                x.Quantity,
                x.Product.DefaultQuantity))
            .ToListAsync(cancellationToken);
}

FILE: src\Fridge.Application\Features\Fridges\Queries\GetFridges\GetFridgesQuery.cs
using MediatR;
using Fridge.Application.Features.Fridges.Dtos;

namespace Fridge.Application.Features.Fridges.Queries.GetFridges;
public sealed record GetFridgesQuery : IRequest<IReadOnlyList<FridgeDto>>;

FILE: src\Fridge.Application\Features\Fridges\Queries\GetFridges\GetFridgesQueryHandler.cs

using Fridge.Application.Common.Interfaces;
using Fridge.Application.Features.Fridges.Dtos;
using MediatR;
using Microsoft.EntityFrameworkCore;

namespace Fridge.Application.Features.Fridges.Queries.GetFridges;

public sealed class GetFridgesQueryHandler(IAppDbContext db)
    : IRequestHandler<GetFridgesQuery, IReadOnlyList<FridgeDto>>
{
    public async Task<IReadOnlyList<FridgeDto>> Handle(GetFridgesQuery request, CancellationToken cancellationToken)
        => await db.Fridges
            .AsNoTracking()
            .Include(x => x.Model)
            .Select(x => new FridgeDto(
                x.Id,
                x.Name,
                x.OwnerName,
                x.ModelId,
                x.Model.Name,
                x.Model.Year))
            .ToListAsync(cancellationToken);
}

FILE: src\Fridge.Application\Features\Maintenance\Commands\RestockZeroQuantity\RestockZeroQuantityCommand.cs
using MediatR;

namespace Fridge.Application.Features.Maintenance.Commands.RestockZeroQuantity;

public sealed record RestockZeroQuantityCommand : IRequest<int>;

FILE: src\Fridge.Application\Features\Maintenance\Commands\RestockZeroQuantity\RestockZeroQuantityCommandHandler.cs
using Fridge.Application.Common.Interfaces;
using MediatR;

namespace Fridge.Application.Features.Maintenance.Commands.RestockZeroQuantity;

public sealed class RestockZeroQuantityCommandHandler(IRestockService restockService)
    : IRequestHandler<RestockZeroQuantityCommand, int>
{
    public async Task<int> Handle(RestockZeroQuantityCommand request, CancellationToken cancellationToken)
        => await restockService.RestockZeroQuantityAsync(cancellationToken);
}

FILE: src\Fridge.Application\Features\Products\Commands\UpdateProduct\UpdateProductCommand.cs
using Fridge.Application.Features.Products.Dtos;
using MediatR;

namespace Fridge.Application.Features.Products.Commands.UpdateProduct;

public sealed record UpdateProductCommand(
    Guid Id,
    string Name,
    int? DefaultQuantity
) : IRequest<ProductDto>;

FILE: src\Fridge.Application\Features\Products\Commands\UpdateProduct\UpdateProductCommandHandler.cs
using Fridge.Application.Common.Interfaces;
using Fridge.Application.Features.Products.Dtos;
using MediatR;
using Microsoft.EntityFrameworkCore;

namespace Fridge.Application.Features.Products.Commands.UpdateProduct;

public sealed class UpdateProductCommandHandler(IAppDbContext db)
    : IRequestHandler<UpdateProductCommand, ProductDto>
{
    public async Task<ProductDto> Handle(UpdateProductCommand request, CancellationToken cancellationToken)
    {
        var product = await db.Products.SingleOrDefaultAsync(x => x.Id == request.Id, cancellationToken);

        if (product is null)
            throw new KeyNotFoundException($"Product '{request.Id}' not found.");

        product.Name = request.Name;
        product.DefaultQuantity = request.DefaultQuantity;

        await db.SaveChangesAsync(cancellationToken);
        return new ProductDto(product.Id, product.Name, product.DefaultQuantity);
    }
}

FILE: src\Fridge.Application\Features\Products\Commands\UpdateProduct\UpdateProductCommandValidator.cs
using FluentValidation;

namespace Fridge.Application.Features.Products.Commands.UpdateProduct;

public sealed class UpdateProductCommandValidator : AbstractValidator<UpdateProductCommand>
{
    public UpdateProductCommandValidator()
    {
        RuleFor(x => x.Id).NotEmpty();
        RuleFor(x => x.Name).NotEmpty().MaximumLength(200);
        RuleFor(x => x.DefaultQuantity)
            .GreaterThan(0)
            .When(x => x.DefaultQuantity.HasValue);
    }
}

FILE: src\Fridge.Application\Features\Products\Commands\UpdateProduct\UpdateProductRequest.cs
namespace Fridge.Application.Features.Products.Commands.UpdateProduct;

public sealed record UpdateProductRequest
(
    string Name,
    int? DefaultQuantity
);

FILE: src\Fridge.Application\Features\Products\Dtos\ProductDto.cs
namespace Fridge.Application.Features.Products.Dtos;

public sealed record ProductDto
(
    Guid Id,
    string Name,
    int? DefaultQuantity
);

FILE: src\Fridge.Application\Features\Products\Queries\GetProductById\GetProductByIdQuery.cs
using Fridge.Application.Features.Products.Dtos;
using MediatR;

namespace Fridge.Application.Features.Products.Queries.GetProductById;

public sealed record GetProductByIdQuery(Guid Id) : IRequest<ProductDto>;

FILE: src\Fridge.Application\Features\Products\Queries\GetProductById\GetProductByIdQueryHandler.cs
using Fridge.Application.Common.Interfaces;
using Fridge.Application.Features.Products.Dtos;
using MediatR;
using Microsoft.EntityFrameworkCore;

namespace Fridge.Application.Features.Products.Queries.GetProductById;

public class GetProductByIdQueryHandler(IAppDbContext db)
    : IRequestHandler<GetProductByIdQuery, ProductDto>
{
    public async Task<ProductDto> Handle(GetProductByIdQuery request, CancellationToken cancellationToken)
    {
        var product = await db
            .Products
            .AsNoTracking()
            .Where(x => x.Id == request.Id)
            .Select(x => new ProductDto(
                x.Id,
                x.Name,
                x.DefaultQuantity
            ))
            .SingleOrDefaultAsync(cancellationToken);

        if (product is null)
            throw new KeyNotFoundException($"Product '{request.Id}' not found.");

        return product;
    }
}

FILE: src\Fridge.Application\Features\Products\Queries\GetProducts\GetProductsQuery.cs
using Fridge.Application.Features.Products.Dtos;
using MediatR;

namespace Fridge.Application.Features.Products.Queries.GetProducts;

public sealed record GetProductsQuery : IRequest<IReadOnlyList<ProductDto>>;

FILE: src\Fridge.Application\Features\Products\Queries\GetProducts\GetProductsQueryHandler.cs
using Fridge.Application.Common.Interfaces;
using Fridge.Application.Features.Products.Dtos;
using MediatR;
using Microsoft.EntityFrameworkCore;

namespace Fridge.Application.Features.Products.Queries.GetProducts;

public sealed class GetProductsQueryHandler(IAppDbContext db)
    : IRequestHandler<GetProductsQuery, IReadOnlyList<ProductDto>>
{
    public async Task<IReadOnlyList<ProductDto>> Handle(GetProductsQuery request, CancellationToken ct)
        => await db.Products
            .AsNoTracking()
            .OrderBy(x => x.Name)
            .Select(x => new ProductDto(
                x.Id,
                x.Name,
                x.DefaultQuantity
            ))
            .ToListAsync(ct);
}

FILE: src\Fridge.Domain\Entities\Fridge.cs
namespace Fridge.Domain.Entities
{
    public class Fridge
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string? OwnerName { get; set; } = string.Empty;

        // FK
        public Guid ModelId { get; set; }
        // Many to one
        public FridgeModel Model { get; set; } = null!;
        // One to many
        public ICollection<FridgeProduct> FridgeProducts { get; set; } = [];
    }
}

FILE: src\Fridge.Domain\Entities\FridgeModel.cs
namespace Fridge.Domain.Entities
{
    public class FridgeModel
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public int? Year { get; set; }

        // One to many
        public ICollection<Fridge> Fridges { get; set; } = new List<Fridge>();

    }
}

FILE: src\Fridge.Domain\Entities\FridgeProduct.cs
namespace Fridge.Domain.Entities
{
    public class FridgeProduct
    {
        public Guid Id { get; set; }
        // FK
        public Guid ProductId { get; set; }
        // Many to one
        public Product Product { get; set; } = null!;
        // FK
        public Guid FridgeId { get; set; }
        // Many to one
        public Fridge Fridge { get; set; } = null!;

        public int Quantity { get; set; }
    }
}

FILE: src\Fridge.Domain\Entities\Product.cs
namespace Fridge.Domain.Entities
{
    public class Product
    {
        public Guid Id { get; set; }

        public string Name { get; set; } = string.Empty;

        public int? DefaultQuantity { get; set; }

        public ICollection<FridgeProduct> FridgeProducts { get; set; } = new List<FridgeProduct>();
    }
}

FILE: src\Fridge.Infrastructure\DependencyInjection.cs
using Fridge.Application.Common.Interfaces;
using Fridge.Infrastructure.Persistence;
using Fridge.Infrastructure.Services;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;

namespace Fridge.Infrastructure
{
    public static class DependencyInjection
    {
        public static IServiceCollection AddInfrastructure(this IServiceCollection services,
        IConfiguration configuration)
        {
            services.AddDbContext<AppDbContext>(options =>
                options.UseSqlServer(configuration.GetConnectionString("DefaultConnection")));

            services.AddScoped<IAppDbContext>(x => x.GetRequiredService<AppDbContext>());
            services.AddScoped<DbSeeder>();
            services.AddScoped<IFridgeProductService, FridgeProductService>();
            services.AddScoped<IRestockService, RestockService>();

            return services;
        }
    }
}

FILE: src\Fridge.Infrastructure\Persistence\AppDbContext .cs
using Fridge.Application.Common.Interfaces;
using Fridge.Domain.Entities;
using Fridge.Infrastructure.Persistence.SpModels;
using Microsoft.EntityFrameworkCore;

namespace Fridge.Infrastructure.Persistence
{
    public class AppDbContext(DbContextOptions<AppDbContext> options) : DbContext(options), IAppDbContext
    {
        public DbSet<Domain.Entities.Fridge> Fridges => Set<Domain.Entities.Fridge>();
        public DbSet<FridgeModel> FridgeModels => Set<FridgeModel>();
        public DbSet<FridgeProduct> FridgeProducts => Set<FridgeProduct>();
        public DbSet<Product> Products => Set<Product>();
        public DbSet<RestockCandidateRow> RestockCandidateRows => Set<RestockCandidateRow>();

        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            modelBuilder.ApplyConfigurationsFromAssembly(typeof(AppDbContext).Assembly);
        }

    }
}

FILE: src\Fridge.Infrastructure\Persistence\Configurations\FridgeConfiguration.cs
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;

namespace Fridge.Infrastructure.Persistence.Configurations
{
    public class FridgeConfiguration : IEntityTypeConfiguration<Domain.Entities.Fridge>
    {
        public void Configure(EntityTypeBuilder<Domain.Entities.Fridge> e)
        {
            e.ToTable("fridge");

            e.HasKey(x => x.Id);
            e.Property(x => x.Id).HasColumnName("id").ValueGeneratedNever();

            e.Property(x => x.Name).HasColumnName("name").IsRequired();
            e.Property(x => x.OwnerName).HasColumnName("owner_name");

            e.Property(x => x.ModelId).HasColumnName("model_id").IsRequired();

            e.HasOne(x => x.Model)
            .WithMany(m => m.Fridges)
            .HasForeignKey(f => f.ModelId)
            .OnDelete(DeleteBehavior.Restrict);
        }
    }
}

FILE: src\Fridge.Infrastructure\Persistence\Configurations\FridgeModelConfiguration.cs
using Fridge.Domain.Entities;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;

namespace Fridge.Infrastructure.Persistence.Configurations
{
    public class FridgeModelConfiguration : IEntityTypeConfiguration<FridgeModel>
    {
        public void Configure(EntityTypeBuilder<FridgeModel> e)
        {
            e.ToTable("fridge_model");

            e.HasKey(x => x.Id);
            e.Property(x => x.Id).HasColumnName("id").ValueGeneratedNever();

            e.Property(x => x.Name).HasColumnName("name").IsRequired();
            e.Property(x => x.Year).HasColumnName("year");


        }
    }
}

FILE: src\Fridge.Infrastructure\Persistence\Configurations\FridgeProductConfiguration.cs
using Fridge.Domain.Entities;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;

namespace Fridge.Infrastructure.Persistence.Configurations
{
    public class FridgeProductConfiguration : IEntityTypeConfiguration<FridgeProduct>
    {
        public void Configure(EntityTypeBuilder<FridgeProduct> e)
        {
            e.ToTable("fridge_products");

            e.HasKey(x => x.Id);
            e.Property(x => x.Id).HasColumnName("id").ValueGeneratedNever();

            e.Property(x => x.ProductId).HasColumnName("product_id").IsRequired();
            e.Property(x => x.FridgeId).HasColumnName("fridge_id").IsRequired();
            e.Property(x => x.Quantity).HasColumnName("quantity").IsRequired();

            e.HasOne(x => x.Product)
            .WithMany(m => m.FridgeProducts)
            .HasForeignKey(f => f.ProductId)
            .OnDelete(DeleteBehavior.Restrict);

            e.HasOne(x => x.Fridge)
            .WithMany(m => m.FridgeProducts)
            .HasForeignKey(f => f.FridgeId)
            .OnDelete(DeleteBehavior.Cascade);
        }
    }
}

FILE: src\Fridge.Infrastructure\Persistence\Configurations\ProductConfiguration.cs
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Fridge.Domain.Entities;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;

namespace Fridge.Infrastructure.Persistence.Configurations
{
    public class ProductConfiguration : IEntityTypeConfiguration<Product>
    {
        public void Configure(EntityTypeBuilder<Product> e)
        {
            e.ToTable("products");

            e.HasKey(x => x.Id);
            e.Property(x => x.Id).HasColumnName("id").ValueGeneratedNever();

            e.Property(x => x.Name).HasColumnName("name").IsRequired();
            e.Property(x => x.DefaultQuantity).HasColumnName("default_quantity");
        }
    }
}

FILE: src\Fridge.Infrastructure\Persistence\Configurations\StoredProcedures\RestockCandidateRowConfiguration.cs
using Fridge.Infrastructure.Persistence.SpModels;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;

namespace Fridge.Infrastructure.Persistence.Configurations.StoredProcedures;

public class RestockCandidateRowConfiguration : IEntityTypeConfiguration<RestockCandidateRow>
{
    public void Configure(EntityTypeBuilder<RestockCandidateRow> builder)
    {
        builder.HasNoKey();
        builder.Property(x => x.FridgeProductId).HasColumnName("fridge_product_id");
        builder.Property(x => x.FridgeId).HasColumnName("fridge_id");
        builder.Property(x => x.ProductId).HasColumnName("product_id");
        builder.Property(x => x.DefaultQuantity).HasColumnName("default_quantity");
    }
}

FILE: src\Fridge.Infrastructure\Persistence\DbSeeder.cs
using Fridge.Domain.Entities;
using Microsoft.EntityFrameworkCore;

namespace Fridge.Infrastructure.Persistence;

public sealed class DbSeeder(AppDbContext db)
{
    private readonly AppDbContext _db = db;

    public async Task SeedAsync(CancellationToken cancellationToken = default)
    {
        await _db.Database.MigrateAsync(cancellationToken);

        if (!await _db.FridgeModels.AnyAsync(cancellationToken))
        {
            var models = new[]
            {
                new FridgeModel { Id = Guid.NewGuid(), Name = "Fridge Model 1", Year = 2020 },
                new FridgeModel { Id = Guid.NewGuid(), Name = "Fridge Model 2", Year = 2021},
                new FridgeModel { Id = Guid.NewGuid(), Name = "Fridge Model 3", Year = 2022 },
                new FridgeModel { Id = Guid.NewGuid(), Name = "Fridge Model 4", Year = 2023},
                new FridgeModel { Id = Guid.NewGuid(), Name = "Fridge Model 5", Year = 2024 }
            };

            _db.FridgeModels.AddRange(models);
            await _db.SaveChangesAsync(cancellationToken);
        }

        if (!await _db.Products.AnyAsync(cancellationToken))
        {
            var products = new[]
            {
                new Product { Id = Guid.NewGuid(), Name = "Milk", DefaultQuantity = 2 },
                new Product { Id = Guid.NewGuid(), Name = "Eggs", DefaultQuantity = 10 },
                new Product { Id = Guid.NewGuid(), Name = "Cheese", DefaultQuantity = 1 },
                new Product { Id = Guid.NewGuid(), Name = "Apples", DefaultQuantity = 6 },
                new Product { Id = Guid.NewGuid(), Name = "Water", DefaultQuantity = 12 }
            };

            _db.Products.AddRange(products);
            await _db.SaveChangesAsync(cancellationToken);
        }

        if (!await _db.Fridges.AnyAsync(cancellationToken))
        {
            var modelIds = await _db.FridgeModels.Select(x => x.Id).ToListAsync(cancellationToken);

            if (modelIds.Count == 0) throw new InvalidOperationException("No fridge models found");

            var fridges = new[]
            {
                new Domain.Entities.Fridge { Id = Guid.NewGuid(), Name = "Fridge 1", OwnerName = "John Doe1", ModelId = modelIds[0]},
                new Domain.Entities.Fridge { Id = Guid.NewGuid(), Name = "Fridge 2", OwnerName = "John Doe2", ModelId = modelIds[1]},
                new Domain.Entities.Fridge { Id = Guid.NewGuid(), Name = "Fridge 3", OwnerName = "John Doe3", ModelId = modelIds[2]},
                new Domain.Entities.Fridge { Id = Guid.NewGuid(), Name = "Fridge 4", OwnerName = "John Doe4", ModelId = modelIds[3]},
                new Domain.Entities.Fridge { Id = Guid.NewGuid(), Name = "Fridge 5", OwnerName = "John Doe1", ModelId = modelIds[4]},
                new Domain.Entities.Fridge { Id = Guid.NewGuid(), Name = "Fridge 6", OwnerName = "John Doe2", ModelId = modelIds[0]},
                new Domain.Entities.Fridge { Id = Guid.NewGuid(), Name = "Fridge 7", OwnerName = "John Doe3", ModelId = modelIds[1]},
                new Domain.Entities.Fridge { Id = Guid.NewGuid(), Name = "Fridge 8", OwnerName = "John Doe4", ModelId = modelIds[2]},
                new Domain.Entities.Fridge { Id = Guid.NewGuid(), Name = "Fridge 9", OwnerName = "John Doe5", ModelId = modelIds[3]},
                new Domain.Entities.Fridge { Id = Guid.NewGuid(), Name = "Fridge 10", OwnerName = "John Doe6", ModelId = modelIds[4]},
            };

            _db.Fridges.AddRange(fridges);
            await _db.SaveChangesAsync(cancellationToken);
        }

        if (!await _db.FridgeProducts.AnyAsync(cancellationToken))
        {
            var fridgeIds = await _db.Fridges.Select(x => x.Id).ToListAsync(cancellationToken);
            var productIds = await _db.Products.AsNoTracking().ToListAsync(cancellationToken);

            if (fridgeIds.Count == 0 || productIds.Count == 0) throw new InvalidOperationException("No fridge or product found");

            var fridgeProducts = new[]
            {
                new FridgeProduct { Id = Guid.NewGuid(), FridgeId = fridgeIds[0], ProductId = productIds[0].Id, Quantity = 2},
                new FridgeProduct { Id = Guid.NewGuid(), FridgeId = fridgeIds[0], ProductId = productIds[1].Id, Quantity = 1},
                new FridgeProduct { Id = Guid.NewGuid(), FridgeId = fridgeIds[0], ProductId = productIds[2].Id, Quantity = 5},
                new FridgeProduct { Id = Guid.NewGuid(), FridgeId = fridgeIds[0], ProductId = productIds[3].Id, Quantity = 7},
                new FridgeProduct { Id = Guid.NewGuid(), FridgeId = fridgeIds[0], ProductId = productIds[4].Id, Quantity = 3},

                new FridgeProduct { Id = Guid.NewGuid(), FridgeId = fridgeIds[1], ProductId = productIds[0].Id, Quantity = 5},
                new FridgeProduct { Id = Guid.NewGuid(), FridgeId = fridgeIds[1], ProductId = productIds[1].Id, Quantity = 2},
                new FridgeProduct { Id = Guid.NewGuid(), FridgeId = fridgeIds[1], ProductId = productIds[2].Id, Quantity = 4},
                new FridgeProduct { Id = Guid.NewGuid(), FridgeId = fridgeIds[1], ProductId = productIds[3].Id, Quantity = 9},
                new FridgeProduct { Id = Guid.NewGuid(), FridgeId = fridgeIds[1], ProductId = productIds[4].Id, Quantity = 1},

                new FridgeProduct { Id = Guid.NewGuid(), FridgeId = fridgeIds[2], ProductId = productIds[0].Id, Quantity = 7},
                new FridgeProduct { Id = Guid.NewGuid(), FridgeId = fridgeIds[2], ProductId = productIds[1].Id, Quantity = 3},
                new FridgeProduct { Id = Guid.NewGuid(), FridgeId = fridgeIds[2], ProductId = productIds[2].Id, Quantity = 1},


                new FridgeProduct { Id = Guid.NewGuid(), FridgeId = fridgeIds[3], ProductId = productIds[0].Id, Quantity = 0},
                new FridgeProduct { Id = Guid.NewGuid(), FridgeId = fridgeIds[3], ProductId = productIds[1].Id, Quantity = 1},
                new FridgeProduct { Id = Guid.NewGuid(), FridgeId = fridgeIds[3], ProductId = productIds[2].Id, Quantity = 0},
                new FridgeProduct { Id = Guid.NewGuid(), FridgeId = fridgeIds[3], ProductId = productIds[3].Id, Quantity = 0},
                new FridgeProduct { Id = Guid.NewGuid(), FridgeId = fridgeIds[3], ProductId = productIds[4].Id, Quantity = 0}
            };

            _db.FridgeProducts.AddRange(fridgeProducts);
            await _db.SaveChangesAsync(cancellationToken);
        }
    }
}

FILE: src\Fridge.Infrastructure\Persistence\SpModels\RestockCandidateRow.cs
namespace Fridge.Infrastructure.Persistence.SpModels;

public sealed class RestockCandidateRow
{
    public Guid FridgeProductId;
    public Guid ProductId;
    public Guid FridgeId;
    public int DefaultQuantity;
}

FILE: src\Fridge.Infrastructure\Services\FridgeProductService.cs
using Fridge.Application.Common.Interfaces;
using Fridge.Domain.Entities;
using Microsoft.EntityFrameworkCore;

namespace Fridge.Infrastructure.Services
{
    public sealed class FridgeProductService(IAppDbContext db) : IFridgeProductService
    {
        public async Task<Guid> AddProductAsync(Guid fridgeId, Guid productId, int quantity, bool saveChanges = true, CancellationToken ct = default)
        {
            if (quantity <= 0)
                throw new ArgumentOutOfRangeException(nameof(quantity), "Quantity must be grater than 0");

            if (!await db.Fridges.AnyAsync(x => x.Id == fridgeId, ct))
                throw new KeyNotFoundException($"Fridge {fridgeId} not found");

            if (!await db.Products.AnyAsync(x => x.Id == productId, ct))
                throw new KeyNotFoundException($"Product {productId} not found");

            var existing = await db.FridgeProducts.SingleOrDefaultAsync(x => x.ProductId == productId && x.FridgeId == fridgeId, ct);
            Guid id;

            if (existing is null)
            {
                var entity = new FridgeProduct
                {
                    Id = Guid.NewGuid(),
                    FridgeId = fridgeId,
                    ProductId = productId,
                    Quantity = quantity
                };

                db.FridgeProducts.Add(entity);
                id = entity.Id;
            }
            else
            {
                existing.Quantity += quantity;
                id = existing.Id;
            }

            if (saveChanges)
                await db.SaveChangesAsync(ct);

            return id;
        }
    }
}

FILE: src\Fridge.Infrastructure\Services\RestockService.cs
using Fridge.Application.Common.Exceptions;
using Fridge.Application.Common.Interfaces;
using Fridge.Infrastructure.Persistence;
using Microsoft.EntityFrameworkCore;

namespace Fridge.Infrastructure.Services;

public sealed class RestockService(AppDbContext db, IFridgeProductService fridgeProductService)
    : IRestockService
{
    public async Task<int> RestockZeroQuantityAsync(CancellationToken ct = default)
    {
        var candidates = await db.RestockCandidateRows
            .FromSqlRaw("EXEC dbo.sp_RestockZeroQuantity")
            .AsNoTracking()
            .ToListAsync(ct);

        if (candidates.Count == 0)
            return 0;

        await using var tx = await db.Database.BeginTransactionAsync(ct);
        var processed = 0;
        foreach (var c in candidates)
        {
            if (c.DefaultQuantity <= 0)
                throw new BusinessRuleViolationException(
                     $"Product '{c.ProductId}' has invalid default quantity '{c.DefaultQuantity}'. Fix products.default_quantity and retry restock.");

            await fridgeProductService.AddProductAsync(c.FridgeId, c.ProductId, c.DefaultQuantity, false, ct);
            processed++;
        }

        await db.SaveChangesAsync(ct);
        await tx.CommitAsync(ct);

        return processed;
    }
}

FILE: tests\Fridge.Application.Tests\UnitTest1.cs
namespace Fridge.Application.Tests;

public class UnitTest1
{
    [Fact]
    public void Test1()
    {

    }
}

